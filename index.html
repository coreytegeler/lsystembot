<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title></title>
	<style>
		body {margin: 0;}
		canvas {
			display: table;
			margin: auto;
		}
		form {
			padding: 50px;
			border-top: 4px solid black;
		}
		label {
			font-size: 45px;
			float: left;
		}
		input {
			width: 300px;
			height: 50px;
			padding: 10px;
			font-size: 45px;
			line-height: 50px;
			font-weight: bold;
			color: black;
			outline: none;
			border: 4px solid black;
			text-transform: uppercase;
		}
	</style>
	<script type="text/javascript" src="paper-full.min.js"></script>
	<script type="text/javascript" src="jquery-2.1.4.min.js"></script>
	<script type="text/paperscript" canvas="canvas">
		$('main').height(window.innerHeight);
		width = 960;
		height = 560;
		view.viewSize = new Size(width, height);
		generate();

		function download(fileName) {
		   if(!fileName) {
		       fileName = "paperjs_example.svg"
		   }

		   var url = "data:image/svg+xml;utf8," + encodeURIComponent(project.exportSVG({asString:true}));

		   var link = document.createElement("a");
		   link.download = fileName;
		   link.href = url;
		   link.click();
		}

		function chooseRandom(arr) {
		    return arr[Math.floor(Math.random() * arr.length)];
		}

		function genRandomString(min, max, charSet) {
		    var length = Math.floor(Math.random() * (max - min)) + min;
		    var str = '';

		    for(var i = 0; i < length; i++) {
		        var char = chooseRandom(charSet);
		        if(char === ']') {
		            var insertIndex = Math.floor(Math.random()*(str.length));
		            str = str.substring(0, insertIndex) + '[' + str.substring(insertIndex);
		        }
		        str += char;
		    }
		    return str;
		}

		function generate() {
		    var system = {};
		    var killOrder = ['a', 'iter', 'wiggly'];
		    var charSet = ['F'];
		    var alphabet = 'ABCDEGHIJKLMNOPQRSTUVWXYZ'.split('');
		    var controlCharSet = ['F', '+', '-', ']'];
		    var angles = [36, 45, 60, 90];
		    var iters = [4, 5, 6, 7];
		    var wigglies = [true, false];
		    var i, index;

		    var extraSymbols = Math.floor(Math.random()*5) + 1;
		    for(i = 0; i < extraSymbols; i++) {
		        index = Math.floor(Math.random()*alphabet.length);
		        charSet.push(alphabet.splice(index, 1)[0]);
		    }

		    system.start = genRandomString(1, 5, charSet);
		    
		    system.rules = {};
		    charSet.forEach(function(char) {
		        var ruleStr = genRandomString(0, 10, charSet.concat(controlCharSet));
		        if(ruleStr.length > 0) {
		            system.rules[char] = ruleStr;
		        }
		    });


		    // choose optional parameters (if not specified, random values are chosen later)
		    system.a = chooseRandom(angles);
		    system.iter = chooseRandom(iters);
		    if(chooseRandom(wigglies)) {
		        system.wiggly = true;
		    }
		    $('input').val(JSON.stringify(system.rules));
		    // console.log(system);
		    expand(system);
		}



		function chooseRandom(arr) {
		    return arr[Math.floor(Math.random() * arr.length)];
		}

		function expand(system, minLength) {
		    minLength = minLength === undefined ? 0 : minLength;
		    var start = system.start;
		    var rules = system.rules;
		    var angle = system['a'] || chooseRandom([36, 45, 60, 90]);
		    var iterations = system.iter || chooseRandom([3, 4, 5, 6]);
		    var color = system.color || new Color({
		        hue: Math.random()*360,
		        saturation: Math.random()*0.8 + 0.2,
		        brightness: Math.random()*0.8 + 0.2,
		        alpha: 1.0
		    });
		    var smooth = system.wiggly || (Math.random() < 0.1);

		    var iterate = function(str, rules) {
		        var out = '', result;
		        str.split('').forEach(function(character) {
		            result = rules[character];
		            if(result) {
		                out += result;
		            } else {
		                out += character;
		            }
		        });
		        return out;
		    };

		    var system = start;
		    for(var i=0; i<iterations; i++) {
		        system = iterate(system, rules);
				if(system.length > 10000) {
					// generate();
				}
		    }

		    
		    var check = system.match(/F/g) || { length: 0 };

		    // if(check.length < minLength) {
		    //	return null;
		    // }

		    var commands = system.split('');
		    var currentPoint = new Point(0, 0);
		    var movement = new Point(0, -10);
		    var stack = [];
		    var translations = {
		        'F': function(path) { currentPoint = currentPoint.add([movement.x, movement.y]); path.lineTo(currentPoint); },
		        '+': function(path) { movement = movement.rotate(angle, new Point(0, 0)); },
		        '-': function(path) { movement = movement.rotate(-angle, new Point(0, 0)); },
		        '[': function(path) { stack.push(currentPoint); stack.push(movement); },
		        ']': function(path) { movement = stack.pop(); currentPoint = stack.pop(); path.moveTo(currentPoint); }
		    };
		    var path = new CompoundPath({
		    	strokeColor: '#000',
		    	strokeWidth: 2.0,
		    	strokeJoin: 'bevel'
		    });
		    path.moveTo(currentPoint);
		    commands.forEach(function(command) {
		        var translation = translations[command];
		        if(translation) {
		            translation(path);
		        }
		    });
		    path.fitBounds(new Rectangle(20, 20, width-40, height-40));
		    view.viewSize = new Size(width, height);
		    path.center = view.center;

		    if(smooth) {
		        path.smooth();
		    }

		    $('#canvas').click(function() {
		    	download('lsystem');
		    });
		}

	</script>
</head>
<body>
	<main id="top">
		<canvas id="canvas"></canvas>
	</main>
	<!-- <main id="bottom">
		<form>
			<label></label>
			<input type="text">
		</form>
	</main> -->
</body>
</html>